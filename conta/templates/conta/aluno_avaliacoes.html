{% extends 'menu.html' %}
{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card-custom">
                <h1 class="text-center mb-4">Lista de Avaliações do aluno {{aluno.nome}}</h1>



                        {% for questionario in avaliacoes %}
        <div class="accordion-item mb-3 border-0">
            <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                <div class="accordion-button collapsed shadow-sm w-100" 
                     role="button"
                     data-bs-toggle="collapse"
                     data-bs-target="#collapse{{ forloop.counter }}"
                     aria-expanded="false"
                     aria-controls="collapse{{ forloop.counter }}">
                    <div class="row w-100 align-items-center">
                        <div class="col-4">
                            <span style="color: var(--cor-principal); font-weight: bold;">
                                {{ questionario.paciente.nome }}
                            </span>
                        </div>
                        <div class="col-3">
                            <span class="text-muted">{{ questionario.data|date:"d/m/Y" }}</span>
                        </div>
                        <div class="col-3 diagnostico-label">
                            {{ questionario.diagnostico }}
                        </div>
                        
                        <div class="col-2 export-btn-container">
                            <a href="{% url 'exportar_diagnostico_pdf' questionario.id %}"
                               onclick="iniciarDownload(event, this)"
                               class="btn btn-outline-primary btn-sm">
                                <span class="texto-original">Exportar PDF</span>
                                <span class="texto-loading d-none">
                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                    Gerando...
                                </span>
                            </a>
                        </div>
                    </div>
                </div>
            </h2>
            <div id="collapse{{ forloop.counter }}"
                 class="accordion-collapse collapse"
                 aria-labelledby="heading{{ forloop.counter }}"
                 data-bs-parent="#avaliacoesAccordion">
                <div class="accordion-body">
                    <table class="table table-bordered mb-1">
                        <thead>
                            <tr>
                                <th>Etapa</th>
                                <th>Valor Obtido</th>
                                <th>Referência</th>
                                <th>Interpretação</th>
                            </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td>Força</td>
                            <td>
                                {% if questionario.respostas.forca %}
                                    {{ questionario.respostas.forca }}
                                {% else %}
                                    <span class="etapa-descricao">Não avaliado</span>
                                {% endif %}
                            </td>
                            <td>0 = Nenhuma, 1 = Alguma, 2 = Muita dificuldade/não consegue</td>
                            <td>
                                {% if questionario.respostas.forca %}
                                    {% if questionario.respostas.forca == "2" %}
                                        <span class="badge badge-grave">Fraqueza muscular</span>
                                    {% elif questionario.respostas.forca == "1" %}
                                        <span class="badge badge-alerta">Alguma dificuldade</span>
                                    {% else %}
                                        <span class="badge badge-normal">Sem dificuldade</span>
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td>Ajuda para Caminhada</td>
                            <td>
                                {% if questionario.respostas.ajuda_caminhada %}
                                    {{ questionario.respostas.ajuda_caminhada }}
                                {% else %}
                                    <span class="etapa-descricao">Não avaliado</span>
                                {% endif %}
                            </td>
                            <td>0 = Nenhuma, 1 = Alguma, 2 = Muita/Usa apoio/Incapaz</td>
                            <td>
                                {% if questionario.respostas.ajuda_caminhada %}
                                    {% if questionario.respostas.ajuda_caminhada == "2" %}
                                        <span class="badge badge-grave">Mobilidade comprometida</span>
                                    {% elif questionario.respostas.ajuda_caminhada == "1" %}
                                        <span class="badge badge-alerta">Alguma dificuldade</span>
                                    {% else %}
                                        <span class="badge badge-normal">Sem dificuldade</span>
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td>Levantar da Cadeira</td>
                            <td>
                                {% if questionario.respostas.levantar %}
                                    {{ questionario.respostas.levantar }}
                                {% else %}
                                    <span class="etapa-descricao">Não avaliado</span>
                                {% endif %}
                            </td>
                            <td>0 = Nenhuma, 1 = Alguma, 2 = Muita/Não consegue sem ajuda</td>
                            <td>
                                {% if questionario.respostas.levantar %}
                                    {% if questionario.respostas.levantar == "2" %}
                                        <span class="badge badge-grave">Não consegue levantar sem ajuda</span>
                                    {% elif questionario.respostas.levantar == "1" %}
                                        <span class="badge badge-alerta">Alguma dificuldade</span>
                                    {% else %}
                                        <span class="badge badge-normal">Sem dificuldade</span>
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td>Subir Escadas</td>
                            <td>
                                {% if questionario.respostas.subir %}
                                    {{ questionario.respostas.subir }}
                                {% else %}
                                    <span class="etapa-descricao">Não avaliado</span>
                                {% endif %}
                            </td>
                            <td>0 = Nenhuma, 1 = Alguma, 2 = Muita dificuldade/não consegue</td>
                            <td>
                                {% if questionario.respostas.subir %}
                                    {% if questionario.respostas.subir == "2" %}
                                        <span class="badge badge-grave">Dificuldade importante</span>
                                    {% elif questionario.respostas.subir == "1" %}
                                        <span class="badge badge-alerta">Alguma dificuldade</span>
                                    {% else %}
                                        <span class="badge badge-normal">Sem dificuldade</span>
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td>Quedas (últimos 12 meses)</td>
                            <td>
                                {% if questionario.respostas.queda %}
                                    {{ questionario.respostas.queda }}
                                {% else %}
                                    <span class="etapa-descricao">Não avaliado</span>
                                {% endif %}
                            </td>
                            <td>0 = Nenhuma, 1 = 1-3 quedas, 2 = 4 ou mais</td>
                            <td>
                                {% if questionario.respostas.queda %}
                                    {% if questionario.respostas.queda == "2" %}
                                        <span class="badge badge-grave">Alto risco de queda</span>
                                    {% elif questionario.respostas.queda == "1" %}
                                        <span class="badge badge-alerta">Algumas quedas</span>
                                    {% else %}
                                        <span class="badge badge-normal">Nenhuma queda</span>
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td>Circunferência da Panturrilha</td>
                            <td>
                                {% if questionario.respostas.circunferencia_panturrilha %}
                                    {{ questionario.respostas.circunferencia_panturrilha }} cm
                                {% else %}
                                    <span class="etapa-descricao">Não avaliado</span>
                                {% endif %}
                            </td>
                            <td>Suspeita de Sarcopenia, Mulheres <= 33cm / Homens: <= 34cm</td>
                            <td>
                                {% if questionario.respostas.circunferencia_panturrilha %}
                                    {% if questionario.paciente.sexo == 'F' %}
                                        {% if questionario.respostas.circunferencia_panturrilha <= 33 %}
                                            <span class="badge badge-grave">Menor que referência</span>
                                        {% else %}
                                            <span class="badge badge-normal">Adequado</span>
                                        {% endif %}
                                    {% else %}
                                        {% if questionario.respostas.circunferencia_panturrilha <= 34 %}
                                            <span class="badge badge-grave">Menor que referência</span>
                                        {% else %}
                                            <span class="badge badge-normal">Adequado</span>
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td>Segunda Etapa</td>
                            <td>
                                {% if questionario.respostas.segunda_etapa %}
                                    {{ questionario.respostas.segunda_etapa }}
                                {% else %}
                                    <span class="etapa-descricao">Não avaliado</span>
                                {% endif %}
                                {% if questionario.respostas.valor_segunda_etapa %}
                                    - {{ questionario.respostas.valor_segunda_etapa }}
                                {% endif %}
                            </td>
                            <td>Ver protocolo (força preensão ou levantar/sentar)</td>
                            <td>
                                {% if questionario.respostas.segunda_etapa %}
                                    {% if questionario.respostas.segunda_etapa == "Forca Preensar" %}
                                        {% if questionario.paciente.sexo == "F" %}
                                            {% if questionario.respostas.valor_segunda_etapa < 16 %}
                                                <span class="badge badge-grave">Fraqueza muscular</span>
                                            {% else %}
                                                <span class="badge badge-normal">Normal</span>
                                            {% endif %}
                                        {% else %}
                                            {% if questionario.respostas.valor_segunda_etapa < 27 %}
                                                <span class="badge badge-grave">Fraqueza muscular</span>
                                            {% else %}
                                                <span class="badge badge-normal">Normal</span>
                                            {% endif %}
                                        {% endif %}
                                    {% else %}
                                        {% if questionario.respostas.valor_segunda_etapa > 15 %}
                                            <span class="badge badge-alerta">Desempenho reduzido</span>
                                        {% else %}
                                            <span class="badge badge-normal">Normal</span>
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td>Terceira Etapa</td>
                            <td>
                                {% if questionario.respostas.terceira_etapa %}
                                    {{ questionario.respostas.terceira_etapa }}
                                {% else %}
                                    <span class="etapa-descricao">Não avaliado</span>
                                {% endif %}
                                {% if questionario.respostas.valor_terceira_etapa %}
                                    - {{ questionario.respostas.valor_terceira_etapa }}
                                {% endif %}
                            </td>
                            <td>Ver protocolo (MMEA ou IMMEA)</td>
                            <td>
                                {% if questionario.respostas.terceira_etapa %}
                                    {% if questionario.respostas.terceira_etapa == "MMEA" %}
                                        {% if questionario.paciente.sexo == "F" %}
                                            {% if questionario.respostas.valor_terceira_etapa < 20 %}
                                                <span class="badge badge-grave">Massa muscular baixa</span>
                                            {% else %}
                                                <span class="badge badge-normal">Normal</span>
                                            {% endif %}
                                        {% else %}
                                            {% if questionario.respostas.valor_terceira_etapa < 15 %}
                                                <span class="badge badge-grave">Massa muscular baixa</span>
                                            {% else %}
                                                <span class="badge badge-normal">Normal</span>
                                            {% endif %}
                                        {% endif %}
                                    {% else %}
                                        {% if questionario.paciente.sexo == "F" %}
                                            {% if questionario.respostas.valor_terceira_etapa < 6.4 %}
                                                <span class="badge badge-grave">Baixa (IMMEA)</span>
                                            {% else %}
                                                <span class="badge badge-normal">Normal</span>
                                            {% endif %}
                                        {% else %}
                                            {% if questionario.respostas.valor_terceira_etapa < 8.9 %}
                                                <span class="badge badge-grave">Baixa (IMMEA)</span>
                                            {% else %}
                                                <span class="badge badge-normal">Normal</span>
                                            {% endif %}
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td>Velocidade da Caminhada</td>
                            <td>
                                {% if questionario.respostas.valor_quarta_etapa %}
                                    {{ questionario.respostas.valor_quarta_etapa }} s
                                {% else %}
                                    <span class="etapa-descricao">Não avaliado</span>
                                {% endif %}
                            </td>
                            <td>Tempo para 4 metros (&le; 5s = &ge; 0,8m/s)</td>
                            <td>
                                {% if questionario.respostas.valor_quarta_etapa %}
                                    {% with velocidade=4|divisibleby:questionario.respostas.valor_quarta_etapa %}
                                        {% if velocidade <= 0.8 %}
                                            <span class="badge badge-grave">Caminhada lenta (grave)</span>
                                        {% else %}
                                            <span class="badge badge-normal">Normal</span>
                                        {% endif %}
                                    {% endwith %}
                                {% endif %}
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="card card-custom">
            <div class="card-body">
                <p class="text-center text-muted mb-0">Nenhum questionário disponível no histórico.</p>
            </div>
        </div>
        {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}